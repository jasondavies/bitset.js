// Copyright (c) 2012, Jason Davies, http://www.jasondavies.com/
// See LICENSE for details.
//
// EWAH code based on JavaEWAH, https://github.com/lemire/javaewah
// Copyright 2009-2012, Daniel Lemire, Cliff Moon, David McIntosh and Robert
// Becho. Licensed under APL 2.0.
// See lib/javaewah/LICENSE for details.
(function(a){function k(a){arguments.length||(a=1),this.buffer=B(a),this.rlw=new F(this.buffer,0),this.actualsizeinwords=1,this.sizeinbits=0}function l(a){return function(b){var c=new H;return n.call(this,b,c,a),c.n}}function m(a){return function(b){var c=new k;return u.call(c,Math.max(this.actualsizeinwords,b.actualsizeinwords)),n.call(this,b,c,a),c}}function n(a,b,c){var d=c(1,0)&&!c(1,1)&&!c(0,1)&&!c(0,0),e=new A(a.buffer,a.actualsizeinwords),f=new A(this.buffer,this.actualsizeinwords);(!e.hasNext()||!f.hasNext())&&b.setSizeInBits(this.sizeinbits);var g=new G(e.next());d&&(g.RunningBit=!g.RunningBit);var h=new G(f.next());for(;;){var i=g.size()<h.size(),j=i?g:h,k=i?h:g;if(d?j.RunningBit:c(0,j.RunningBit)^c(1,j.RunningBit)){var l=k.RunningLength,m=j.RunningLength,n=Math.min(m,l);b.addStreamOfEmptyWords(k.RunningBit,n);var o=k.dirtywordoffset+(i?f.dirtyWords():e.dirtyWords()),p=i?f.rlw.array:e.rlw.array;b.addStreamOfDirtyWords(p,o,m-n,d&&!i),k.discardFirstWords(m)}else b.addStreamOfEmptyWords(j.RunningBit,j.RunningLength),k.discardFirstWords(j.RunningLength);j.RunningLength=0;var l=k.RunningLength;if(l>0){var q=j.NumberOfLiteralWords,n=Math.min(q,l);if(d?k.RunningBit:c(k.RunningBit,0)^c(k.RunningBit,1)){var r=j.dirtywordoffset+(i?e.dirtyWords():f.dirtyWords()),p=i?e.rlw.array:f.rlw.array;b.addStreamOfDirtyWords(p,r,n,d&&i),k.discardFirstWords(n),j.discardFirstWords(n)}else k.discardFirstWords(n),j.discardFirstWords(n),b.addStreamOfEmptyWords(k.RunningBit,n)}var q=j.NumberOfLiteralWords;if(q>0){var u=k,v=j;i&&(u=j,v=k);var w=v.dirtywordoffset+f.dirtyWords(),x=u.dirtywordoffset+e.dirtyWords();for(var y=0;y<q;++y)b.add(c(f.rlw.array[w+y],e.rlw.array[x+y]));k.discardFirstWords(q)}if(i){if(!e.hasNext()){g=null;break}g.resetRLW(e.next()),d&&(g.RunningBit=!g.RunningBit)}else{if(!f.hasNext()){h=null;break}h.resetRLW(f.next())}}g!=null&&(c(0,1)?t:s)(g,e,b),h!=null&&(c(1,0)?t:s)(h,f,b),b.sizeinbits=Math.max(this.sizeinbits,a.sizeinbits)}function o(a){return a>>>1&65535}function p(a){return a>>>17}function q(a){return new Int32Array(a)}function r(a,b,c){for(var d=b;d<b+c;d++)a[d]=~a[d]}function s(a,b,c){var d=a;for(;;){c.addStreamOfEmptyWords(!1,d.RunningLength+d.NumberOfLiteralWords);if(!b.hasNext())break;d=new G(b.next())}}function t(a,b,c){var d=a;for(;;){var e=d.RunningLength;c.addStreamOfEmptyWords(d.RunningBit,e),c.addStreamOfDirtyWords(b.rlw.array,b.dirtyWords()+d.dirtywordoffset,d.NumberOfLiteralWords);if(!b.hasNext())break;d=new G(b.next())}}function u(a){if(a<=this.buffer.length)return;var b=this.buffer;this.buffer=B(a),this.buffer.set(b),this.rlw.array=this.buffer}function v(a){var b="BitSet, size in bits = "+this.sizeinbits+" size in words = "+this.actualsizeinwords+"\n",c=new A(this.buffer,this.actualsizeinwords);while(c.hasNext()){var d=c.next();b+=d.getRunningLength()+(d.getRunningBit()?"1x11":"0x00")+"\n"+d.getNumberOfLiteralWords()+" dirties\n",a&&(b+=a(c,d))}return b}function w(a,b){if(a.actualsizeinwords==a.buffer.length){var c=a.buffer;a.buffer=B(c.length<<1),a.buffer.set(c),a.rlw.array=a.buffer}a.buffer[a.actualsizeinwords++]=b}function x(a,b,c,d){while(this.actualsizeinwords+c>=this.buffer.length){var e=this.buffer;this.buffer=B(e.length<<1),this.buffer.set(e),this.rlw.array=this.buffer}this.buffer.set(a.subarray(b,b+c),this.actualsizeinwords);if(d)for(var f=this.actualsizeinwords;f<this.actualsizeinwords+c;f++)this.buffer[f]=~this.buffer[f];this.actualsizeinwords+=c}function y(a){var b=this.rlw.getNumberOfLiteralWords()==0,c=this.rlw.getRunningLength();b&&c==0&&this.rlw.setRunningBit(a),b&&this.rlw.getRunningBit()==a&&c<f?this.rlw.setRunningLength(c+1):(w(this,0),this.rlw.position=this.actualsizeinwords-1,this.rlw.setRunningBit(a),this.rlw.setRunningLength(1))}function z(a){var b=this.rlw.getNumberOfLiteralWords();b>=e?(w(this,0),this.rlw.position=this.actualsizeinwords-1,this.rlw.setNumberOfLiteralWords(1),w(this,a)):(this.rlw.setNumberOfLiteralWords(b+1),w(this,a))}function A(a,b){this.rlw=new F(a,0),this.size=b,this.pointer=0}function B(a){return new Int32Array(a)}function C(a){return D((a&-a)-1)}function D(a){return a-=a>>1&1431655765,a=(a>>2&858993459)+(a&858993459),a=(a>>4)+a&252645135,a+=a>>8,a+=a>>16,a&63}function E(a){return a-=a>>1&1431655765,a=(a&858993459)+(a>>2&858993459),(a+(a>>4)&252645135)*16843009>>24}function F(a,b){this.array=a,this.position=b}function G(a){this.reset(a.array[a.position])}function H(){this.n=0}a.BitSet=k;var b=32,c=16,d=31-c,e=(1<<d)-1,f=(1<<c)-1,g=f<<1,h=~g,i=(1<<c+1)-1,j=~i;k.prototype.set=function(a){var c=this.sizeinbits;if(a<c)return!1;var d=(a+b>>5)-(c+b-1>>5);return this.sizeinbits=a+1,d>0?(d>1&&this.addStreamOfEmptyWords(!1,d-1),z.call(this,1<<(a&31)),!0):this.rlw.getNumberOfLiteralWords()==0?(this.rlw.setRunningLength(this.rlw.getRunningLength()-1),z.call(this,1<<(a&31)),!0):(this.buffer[this.actualsizeinwords-1]|=1<<(a&31),this.buffer[this.actualsizeinwords-1]==~0&&(this.buffer[this.actualsizeinwords-1]=0,--this.actualsizeinwords,this.rlw.setNumberOfLiteralWords(this.rlw.getNumberOfLiteralWords()-1),y.call(this,!0)),!0)},k.prototype.add=function(a,c){this.sizeinbits+=c||b,a==0?y.call(this,!1):a==~0?y.call(this,!0):z.call(this,a)},k.prototype.addStreamOfEmptyWords=function(a,b){var c=this.rlw,d=c.getRunningBit();if(d!=a&&c.size()==0)c.setRunningBit(a);else if(c.getNumberOfLiteralWords()!=0||d!=a)w(this,0),c.position=this.actualsizeinwords-1,a&&c.setRunningBit(a);var e=c.getRunningLength(),g=Math.min(b,f-e);c.setRunningLength(e+g),b-=g;while(b>=f)w(this,0),c.position=this.actualsizeinwords-1,a&&c.setRunningBit(a),c.setRunningLength(f),b-=f;b>0&&(w(this,0),c.position=this.actualsizeinwords-1,a&&c.setRunningBit(a),c.setRunningLength(b))},k.prototype.addStreamOfDirtyWords=function(a,b,c,d){if(c==0)return;var f=this.rlw.getNumberOfLiteralWords(),g=c<e-f?c:e-f;this.rlw.setNumberOfLiteralWords(f+g);var h=c-g;x.call(this,a,b,g,d),this.sizeinbits+=g<<5,h>0&&(w(this,0),this.rlw.position=this.actualsizeinwords-1,this.addStreamOfDirtyWords(a,b+g,h))},k.prototype.cardinality=function(){var a=0,b=new A(this.buffer,this.actualsizeinwords);while(b.hasNext()){var c=b.next();c.getRunningBit()&&(a+=c.getRunningLength()<<5);for(var d=b.rlw.array,e=b.dirtyWords(),f=e+c.getNumberOfLiteralWords();e<f;++e)a+=E(d[e])}return a},k.prototype.or=m(function(a,b){return a|b}),k.prototype.xor=m(function(a,b){return a^b}),k.prototype.and=m(function(a,b){return a&b}),k.prototype.andNot=m(function(a,b){return a&~b}),k.prototype.orCardinality=l(function(a,b){return a|b}),k.prototype.xorCardinality=l(function(a,b){return a^b}),k.prototype.andCardinality=l(function(a,b){return a&b}),k.prototype.andNotCardinality=l(function(a,b){return a&~b}),k.prototype.andGroupCardinality=function(a){var b=this,c=a.length,d=b.buffer,e=b.actualsizeinwords;buffers=a.map(function(a){return a.buffer}),indexes=q(c),positions=q(c),counts=q(c),ap=0,ax=0;while(ap<e){var f=d[ap],g=o(f),h=p(f);ap++;for(var i=0;i<c;i++){var j=indexes[i],k=ax-j,l=a[i].actualsizeinwords,m=0,n=buffers[i],r=positions[i];do{var s=n[r],t=o(s),u=p(s),v=0;m<g&&k<t&&(v=Math.min(g-m,t-k),counts[i]+=(s&f&1)*v<<5,m+=v,k+=v);if(m<g&&k>=t){v=Math.min(g-m,t+u-k);if(f&1)for(var w=0;w<v;w++)counts[i]+=E(n[r+1+k-t+u+w]);m+=v,k+=v,k===t+u&&(j+=t+u,r+=1+u,k=0)}else if(m>=g&&k<t){v=Math.min(g+h-m,t-k);if(s&1)for(var w=0;w<v;w++)counts[i]+=E(d[ap+m-g+w]);m+=v,k+=v}if(m>=g&&k>=t){v=Math.min(g+h-m,t+u-k);for(var w=0;w<v;w++)counts[i]+=E(d[ap+m-g+w]&n[r+1+k-t+w]);k+=v,m+=v,k===t+u&&(j+=t+u,r+=1+u,k=0)}}while(r+k<l&m<g+h);indexes[i]=j,positions[i]=r}ap+=h,ax+=g+h}return counts},k.prototype.toString=function(){return v.call(this)},k.prototype.toDebugString=function(){return v.call(this,function(a,b){var c=[];for(var d=0;d<b.getNumberOfLiteralWords();++d)c.push("	",a.rlw.array[a.dirtyWords()+d],"\n");return c.join("")})},k.prototype.read=function(a){var b=this.buffer,c=this.actualsizeinwords;for(var d=0,e=0,f=0;d<c;){var g=b[d++],h=o(g),i=p(g);if(g&1)for(var j=0;j<h;j++)for(var k=0;k<32;k++)a(e++,f++);else e+=h<<5;for(var j=0;j<i;j++,e+=32){g=b[d++];while(g!==0){var l=C(g);g^=1<<l,a(e+l,f++)}}}},A.prototype.hasNext=function(){return this.pointer<this.size},A.prototype.next=function(){return this.rlw.position=this.pointer,this.pointer+=this.rlw.getNumberOfLiteralWords()+1,this.rlw},A.prototype.dirtyWords=function(){return this.pointer-this.rlw.getNumberOfLiteralWords()},F.prototype.getNumberOfLiteralWords=function(){return this.array[this.position]>>>1+c},F.prototype.setNumberOfLiteralWords=function(a){this.array[this.position]|=j,this.array[this.position]&=a<<c+1|i},F.prototype.setRunningBit=function(a){a?this.array[this.position]|=1:this.array[this.position]&=-2},F.prototype.getRunningBit=function(){return this.array[this.position]&!0},F.prototype.getRunningLength=function(){return this.array[this.position]>>>1&f},F.prototype.setRunningLength=function(a){this.array[this.position]|=g,this.array[this.position]&=a<<1|h},F.prototype.size=function(){return this.getRunningLength()+this.getNumberOfLiteralWords()},G.prototype.resetRLW=function(a){this.reset(a.array[a.position])},G.prototype.reset=function(a){this.NumberOfLiteralWords=a>>>1+c,this.RunningBit=(a&1)!=0,this.RunningLength=a>>>1&f,this.dirtywordoffset=0},G.prototype.discardFirstWords=function(a){this.RunningLength>=a?this.RunningLength-=a:(a-=this.RunningLength,this.RunningLength=0,this.dirtywordoffset+=a,this.NumberOfLiteralWords-=a)},G.prototype.size=function(){return this.RunningLength+this.NumberOfLiteralWords},H.prototype.add=function(a){this.n+=E(a)},H.prototype.addStreamOfEmptyWords=function(a,b){a&&(this.n+=b<<5)},H.prototype.addStreamOfDirtyWords=function(a,b,c){c+=b;while(b<c)this.n+=E(a[b++])}})(this);