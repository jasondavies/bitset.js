// Copyright (c) 2012, Jason Davies, http://www.jasondavies.com/
// See LICENSE for details.
//
// EWAH code based on JavaEWAH, https://github.com/lemire/javaewah
// Copyright 2009-2012, Daniel Lemire, Cliff Moon, David McIntosh and Robert
// Becho. Licensed under APL 2.0.
// See lib/javaewah/LICENSE for details.
(function(a){function k(a){arguments.length||(a=1),this.buffer=t(a),this.rlw=new w(this.buffer,0),this.actualsizeinwords=1,this.sizeinbits=0}function l(a){return function(b){var c=new k;return o.call(c,Math.max(this.actualsizeinwords,b.actualsizeinwords)),m.call(this,b,c,a),c}}function m(a,b,c){var d=new s(a.buffer,a.actualsizeinwords),e=new s(this.buffer,this.actualsizeinwords);(!d.hasNext()||!e.hasNext())&&b.setSizeInBits(this.sizeinbits);var f=new x(d.next());f.RunningBit=c(1,f.RunningBit);var g=new x(e.next());for(;;){var h=f.size()<g.size(),i=h?f:g,j=h?g:f;if(i.RunningBit==0)b.addStreamOfEmptyWords(!1,i.RunningLength),j.discardFirstWords(i.RunningLength),i.RunningLength=0;else{var k=j.RunningLength,l=i.RunningLength,m=k>=l?l:k;b.addStreamOfEmptyWords(j.RunningBit,m);var o=j.dirtywordoffset+(h?e.dirtyWords():d.dirtyWords());h?b.addStreamOfDirtyWords(e.buffer(),o,l-m):b.addStreamOfNegatedDirtyWords(d.buffer(),o,l-m),j.discardFirstWords(l),i.RunningLength=0}var k=j.RunningLength;if(k>0)if(j.getRunningBit()==0){var p=i.NumberOfLiteralWords,m=Math.min(p,k);j.discardFirstWords(m),i.discardFirstWords(m),b.addStreamOfEmptyWords(!1,m)}else{var p=i.NumberOfLiteralWords,q=i.dirtywordoffset+(h?d.dirtyWords():e.dirtyWords()),m=k>=p?p:k;h?b.addStreamOfNegatedDirtyWords(d.buffer(),q,m):b.addStreamOfDirtyWords(e.buffer(),q,m),j.discardFirstWords(m),i.discardFirstWords(m)}var p=i.NumberOfLiteralWords;if(p>0){var r=e,t=d,u=i,v=j;h&&(r=d,t=e,u=j,v=i);for(var w=0;w<p;++w)b.add(c(r.rlw.array[u.dirtywordoffset+r.dirtyWords()+w],t.rlw.array[v.dirtywordoffset+t.dirtyWords()+w]));j.discardFirstWords(p)}if(h){if(!d.hasNext()){f=null;break}f.reset(d.next()),f.setRunningBit(c(1,f.getRunningBit()))}else{if(!e.hasNext()){g=null;break}g.reset(e.next())}}f!=null&&n(f,d,b),g!=null&&discharge(g,e,b),b.sizeinbits=Math.max(this.sizeinbits,a.sizeinbits)}function n(a,b,c){var d=a;for(;;){c.addStreamOfEmptyWords(!1,d.RunningLength+d.NumberOfLiteralWords);if(!b.hasNext())break;d=new x(b.next())}}function o(a){if(a<=this.buffer.length)return;var b=this.buffer;this.buffer=t(a),this.buffer.set(b),this.rlw.array=this.buffer}function p(a){var b="BitSet, size in bits = "+this.sizeinbits+" size in words = "+this.actualsizeinwords+"\n",c=new s(this.buffer,this.actualsizeinwords);while(c.hasNext()){var d=c.next();b+=d.getRunningLength()+(d.getRunningBit()?"1x11":"0x00")+"\n"+d.getNumberOfLiteralWords()+" dirties\n",a&&(b+=a(c,d))}return b}function q(a,b){if(a.actualsizeinwords==a.buffer.length){var c=a.buffer;a.buffer=t(c.length<<1),a.buffer.set(c),a.rlw.array=a.buffer}a.buffer[a.actualsizeinwords++]=b}function r(a,b){var c=a.rlw.getNumberOfLiteralWords();return c>=e?(q(a,0),a.rlw.position=a.actualsizeinwords-1,a.rlw.setNumberOfLiteralWords(1),q(a,b),2):(a.rlw.setNumberOfLiteralWords(c+1),q(a,b),1)}function s(a,b){this.rlw=new w(a,0),this.size=b,this.pointer=0}function t(a){return new Uint32Array(a)}function u(a){return v((a&-a)-1)}function v(a){return a-=a>>1&1431655765,a=(a>>2&858993459)+(a&858993459),a=(a>>4)+a&252645135,a+=a>>8,a+=a>>16,a&63}function w(a,b){this.array=a,this.position=b}function x(a){this.reset(a.array[a.position])}a.BitSet=k;var b=32,c=16,d=31-c,e=(1<<d)-1,f=(1<<c)-1,g=f<<1,h=~g,i=(1<<c+1)-1,j=~i;k.prototype.set=function(a){var b=this.sizeinbits;if(a<b)return!1;var c=!1;if(b&31){var d=(b>>5<<5)+32;d<a+1?this.sizeinbits=d:c=!0}this.addStreamOfEmptyWords(!1,(a>>5)-(this.sizeinbits>>5));var e=a-(this.sizeinbits>>5<<5);if(this.rlw.getNumberOfLiteralWords()==0||this.sizeinbits-1>>5<a>>5){var f=1<<e;r(this,f),c&&!this.rlw.getRunningBit()&&this.rlw.getRunningLength()>0&&this.rlw.setRunningLength(this.rlw.getRunningLength()-1)}else{var g=this.actualsizeinwords-1;this.buffer[g]|=1<<e,this.buffer[g]==~0&&(this.buffer[this.actualsizeinwords=g]=0,this.rlw.setNumberOfLiteralWords(this.rlw.getNumberOfLiteralWords()-1),addEmptyWord(!0))}return this.sizeinbits=a+1,!0},k.prototype.add=function(a,c){return arguments.length<2&&(c=b),this.sizeinbits+=c,a==0?addEmptyWord(!1):a==~0?addEmptyWord(!0):r(this,a)},k.prototype.addStreamOfEmptyWords=function(a,b){if(b==0)return 0;var c=this.rlw.getNumberOfLiteralWords()==0,d=this.rlw.getRunningLength();c&&d==0&&this.rlw.setRunningBit(a);var e=0;if(c&&this.rlw.getRunningBit()==a&&d<f){var g=b<f-d?b:f-d;this.rlw.setRunningLength(d+g),this.sizeinbits+=g<<5,b-g>0&&(e+=this.addStreamOfEmptyWords(a,b-g))}else{q(this,0),++e,this.rlw.position=this.actualsizeinwords-1;var g=b<f?b:f;this.rlw.setRunningBit(a),this.rlw.setRunningLength(g),this.sizeinbits+=g<<5,b-g>0&&(e+=this.addStreamOfEmptyWords(a,b-g))}return e},k.prototype.or=l(function(a,b){return a|b}),k.prototype.xor=l(function(a,b){return a^b}),k.prototype.and=l(function(a,b){return a&b}),k.prototype.andNot=l(function(a,b){return a&~b}),k.prototype.toString=function(){return p.call(this)},k.prototype.toDebugString=function(){return p.call(this,function(a,b){var c=[];for(var d=0;d<b.getNumberOfLiteralWords();++d)c.push("	",a.rlw.array[a.dirtyWords()+d],"\n");return c.join("")})},k.prototype.read=function(a){function k(){while(h==0){if(!l())return!1;n()}return!0}function l(){while(c.hasNext())return e=c.next(),!0;return!1}function m(a){++h;if(h>g.length){var b=g;g=t(g.length<<1),g.set(b)}g[h-1]=a}function n(){i=0,h=0;if(e.getRunningBit())for(var a=0;a<e.getRunningLength();++a)for(var f=0;f<b;++f)m(d++);else d+=e.getRunningLength()<<5;for(var a=0;a<e.getNumberOfLiteralWords();++a){var g=c.rlw.array[c.dirtyWords()+a];while(g!=0){var j=u(g);g^=1<<j,m(j+d)}d+=b}}var c=new s(this.buffer,this.actualsizeinwords),d=0,e=null,f=512,g=t(f),h=0,i=0,j=k(),o=0;while(j){var p=g[i++];h==i&&(h=0,j=k()),a(p,o++)}},s.prototype.hasNext=function(){return this.pointer<this.size},s.prototype.next=function(){return this.rlw.position=this.pointer,this.pointer+=this.rlw.getNumberOfLiteralWords()+1,this.rlw},s.prototype.dirtyWords=function(){return this.pointer-this.rlw.getNumberOfLiteralWords()},w.prototype.getNumberOfLiteralWords=function(){return this.array[this.position]>>>1+c},w.prototype.setNumberOfLiteralWords=function(a){this.array[this.position]|=j,this.array[this.position]&=a<<c+1|i},w.prototype.setRunningBit=function(a){a?this.array[this.position]|=1:this.array[this.position]&=-2},w.prototype.getRunningBit=function(){return(this.array[this.position]&1)!=0},w.prototype.getRunningLength=function(){return this.array[this.position]>>>1&f},w.prototype.setRunningLength=function(a){this.array[this.position]|=g,this.array[this.position]&=a<<1|h},w.prototype.size=function(){return this.getRunningLength()+this.getNumberOfLiteralWords()},x.prototype.reset=function(a){this.NumberOfLiteralWords=a>>>1+c,this.RunningBit=(a&1)!=0,this.RunningLength=a>>>1&f,this.dirtywordoffset=0},x.prototype.discardFirstWords=function(a){this.RunningLength>=a?this.RunningLength-=a:(a-=this.RunningLength,this.RunningLength=0,this.dirtywordoffset+=a,this.NumberOfLiteralWords-=a)},x.prototype.size=function(){return this.RunningLength+this.NumberOfLiteralWords}})(this);